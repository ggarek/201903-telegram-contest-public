import{createCanvas as e}from"./utils/createCanvas.js";import{renderCanvas as t}from"./utils/renderTools.js";import{extractPointerOrTouchOffset as s,isTouchEvent as n}from"./utils/eventUtils.js";const o=(e,t,s)=>e>s?s:e<t?t:e,i=()=>{let e=[];const t=t=>{const s=e.indexOf(t);e[s](),e.splice(1,1)};return{add:s=>e.includes(s)?null:(e.push(s),()=>t(s)),remove:t,close:()=>{e.forEach(e=>e()),e=[]}}};customElements.define("tg-minimap",class extends HTMLElement{constructor(){super();const e=document.getElementById("tg-minimap").content;this.attachShadow({mode:"open"}).appendChild(e.cloneNode(!0)),this.subs=i(),this.hasPendingRender=!1}setStore(e){this.store=e}scheduleRender(){if(this.hasPendingRender)return;const{canvas:e,store:s}=this;window.requestAnimationFrame(()=>{this.hasPendingRender=!1,t(e.getContext("2d"),e.width,e.height,{xscale:s.xscale,yscale:s.yscale,scale:s.scale,charts:s.charts,chartsStyle:s.chartsStyle})}),this.hasPendingRender=!0}getStore(){return this.store?this.store:this.hasAttribute("store")?window[this.getAttribute("store")]:null}connectedCallback(){if(!this.isConnected)return;const t=this.shadowRoot,i=t.getElementById("frame"),d=t.getElementById("minimap"),r=t.getElementById("left-curtain"),a=t.getElementById("right-curtain"),c=this.getStore(),h=e(c.config),l=this.shadowRoot.getElementById("charts");this.canvas=h,l.appendChild(h);let m=0,u=i.clientWidth;i.style.left=0;const v=()=>{r.style.width=`${m}px`,a.style.left=`${m+u}px`};v();const w=(e,t)=>{let s=!1;if(void 0!==t&&t!==u&&(s=!0,u=o(t,50,d.clientWidth),i.style.width=`${u}px`),Number.isFinite(e)&&e!==m&&(s=!0,m=o(e,0,d.clientWidth-i.clientWidth),i.style.left=`${m}px`),!s)return;v();const n=c.canvasWidthScale.rtod(m),r=c.canvasWidthScale.rtod(m+i.clientWidth),a=c.xscale.rtod(n),h=c.xscale.rtod(r);c.frameDomain=[a,h]},E=c.canvasWidthScale.dtor(c.xscale.dtor(c.frameDomain[1]))-c.canvasWidthScale.dtor(c.xscale.dtor(c.frameDomain[0]));w(void 0,E);const g=t.getElementById("mid");let p,x,y;const f=e=>{e.preventDefault();const t=n(e),{x:o,y:i}=s(e);y=m,p={x:o,y:i},x={...p};const d=(e=>t=>{const{x:n,y:o}=s(t);x.x=n,x.y=o;const i=x.x-p.x;e(y+i)})(w),r=t?"touchmove":"mousemove";window.addEventListener(r,d);const a=()=>{h(),l()},c=t?"touchend":"mouseup";window.addEventListener(c,a);const h=this.subs.add(()=>window.removeEventListener(r,d)),l=this.subs.add(()=>window.removeEventListener(c,a))},L=this.shadowRoot.getElementById("left-handle"),b=this.shadowRoot.getElementById("right-handle"),W=e=>{e.preventDefault();const t=n(e),{x:d,y:r}=s(e),a=d,c=m,h=i.clientWidth,l=m+h-50,u=e=>{const{x:t}=s(e),n=a-t,i=o(c-n,0,l);i!==m&&w(i,h+n)},v=()=>{g(),x()},E=t?"touchmove":"mousemove";window.addEventListener(E,u);const g=this.subs.add(()=>window.removeEventListener(E,u)),p=t?"touchend":"mouseup";window.addEventListener(p,v);const x=this.subs.add(()=>window.removeEventListener(p,v))},S=e=>{e.preventDefault();const t=n(e),{x:r,y:a}=s(e),c=r,h=i.clientWidth,l=d.clientWidth-m,v=e=>{const{x:t}=s(e),n=o(h+(t-c),0,l);n!==u&&w(m,n)},E=()=>{p(),y()},g=t?"touchmove":"mousemove";window.addEventListener(g,v);const p=this.subs.add(()=>window.removeEventListener(g,v)),x=t?"touchend":"mouseup";window.addEventListener(x,E);const y=this.subs.add(()=>window.removeEventListener(x,E))},B=e=>{const t=e=>{const{x:t}=s(e);w(t-i.clientWidth/2),d()},o=n(e)?"touchend":"mouseup";window.addEventListener(o,t);const d=this.subs.add(()=>window.removeEventListener(o,t))},I=e=>{e.target===g?f(e):e.target===L?W(e):e.target===b?S(e):B(e)};d.addEventListener("mousedown",I),d.addEventListener("touchstart",I),this.subs.add(()=>d.removeEventListener("mousedown",I)),this.subs.add(()=>d.removeEventListener("touchstart",I))}disconnectedCallback(){this.subs.close()}});
import{createCanvas as e}from"./utils/createCanvas.js";import{renderCanvas as t}from"./utils/renderTools.js";import{extractPointerOrTouchOffset as s,isTouchEvent as n}from"./utils/eventUtils.js";const o=(e,t,s)=>e>s?s:e<t?t:e,i=()=>{let e=[];const t=t=>{const s=e.indexOf(t);e[s](),e.splice(1,1)};return{add:s=>e.includes(s)?null:(e.push(s),()=>t(s)),remove:t,close:()=>{e.forEach(e=>e()),e=[]}}};customElements.define("tg-minimap",class extends HTMLElement{constructor(){super();const e=document.getElementById("tg-minimap").content;this.attachShadow({mode:"open"}).appendChild(e.cloneNode(!0)),this.subs=i(),this.hasPendingRender=!1}setStore(e){this.store=e}scheduleRender(){if(this.hasPendingRender)return;const{canvas:e,store:s}=this;window.requestAnimationFrame(()=>{this.hasPendingRender=!1,t(e.getContext("2d"),e.width,e.height,{xscale:s.xscale,yscale:s.yscale,scale:s.scale,charts:s.charts,chartsStyle:s.chartsStyle})}),this.hasPendingRender=!0}getStore(){return this.store?this.store:this.hasAttribute("store")?window[this.getAttribute("store")]:null}connectedCallback(){if(!this.isConnected)return;const t=this.shadowRoot,i=t.getElementById("frame"),d=t.getElementById("minimap"),a=t.getElementById("left-curtain"),r=t.getElementById("right-curtain"),c=this.getStore(),h=e(c.config),l=this.shadowRoot.getElementById("charts");this.canvas=h,l.appendChild(h);let m=0,u=i.clientWidth;i.style.left=0;const v=()=>{a.style.width=`${m}px`,r.style.left=`${m+u}px`};v();const w=(e,t,{force:s}={force:!1})=>{let n=!1;void 0===t||!s&&t===u||(n=!0,u=o(t,50,d.clientWidth),i.style.width=`${u}px`),Number.isFinite(e)&&(s||e!==m)&&(n=!0,m=o(e,0,d.clientWidth-i.clientWidth),i.style.left=`${m}px`),n&&(v(),E())};this.forceUpdateFrameDomain=(()=>{w(m,u,{force:!0})});const E=this.updateFrameDomain=(()=>{const e=c.canvasWidthScale.rtod(m),t=c.canvasWidthScale.rtod(m+i.clientWidth),s=c.xscale.rtod(e),n=c.xscale.rtod(t);c.frameDomain=[s,n]}),p=c.canvasWidthScale.dtor(c.xscale.dtor(c.frameDomain[1]))-c.canvasWidthScale.dtor(c.xscale.dtor(c.frameDomain[0]));w(void 0,p);const g=t.getElementById("mid");let f,x,y;const L=e=>{e.preventDefault();const t=n(e),{x:o,y:i}=s(e);y=m,f={x:o,y:i},x={...f};const d=(e=>t=>{const{x:n,y:o}=s(t);x.x=n,x.y=o;const i=x.x-f.x;e(y+i)})(w),a=t?"touchmove":"mousemove";window.addEventListener(a,d);const r=()=>{h(),l()},c=t?"touchend":"mouseup";window.addEventListener(c,r);const h=this.subs.add(()=>window.removeEventListener(a,d)),l=this.subs.add(()=>window.removeEventListener(c,r))},b=this.shadowRoot.getElementById("left-handle"),W=this.shadowRoot.getElementById("right-handle"),S=e=>{e.preventDefault();const t=n(e),{x:d,y:a}=s(e),r=d,c=m,h=i.clientWidth,l=m+h-50,u=e=>{const t=s(e).x,n=o(c-(r-t),0,l);n!==m&&w(n,h+(c-n))},v=()=>{p(),f()},E=t?"touchmove":"mousemove";window.addEventListener(E,u);const p=this.subs.add(()=>window.removeEventListener(E,u)),g=t?"touchend":"mouseup";window.addEventListener(g,v);const f=this.subs.add(()=>window.removeEventListener(g,v))},B=e=>{e.preventDefault();const t=n(e),{x:a,y:r}=s(e),c=a,h=i.clientWidth,l=d.clientWidth-m,v=e=>{const{x:t}=s(e),n=o(h+(t-c),0,l);n!==u&&w(m,n)},E=()=>{g(),x()},p=t?"touchmove":"mousemove";window.addEventListener(p,v);const g=this.subs.add(()=>window.removeEventListener(p,v)),f=t?"touchend":"mouseup";window.addEventListener(f,E);const x=this.subs.add(()=>window.removeEventListener(f,E))},I=e=>{const t=e=>{const{x:t}=s(e);w(t-i.clientWidth/2),d()},o=n(e)?"touchend":"mouseup";window.addEventListener(o,t);const d=this.subs.add(()=>window.removeEventListener(o,t))},R=e=>{e.target===g?L(e):e.target===b?S(e):e.target===W?B(e):I(e)};d.addEventListener("mousedown",R),d.addEventListener("touchstart",R),this.subs.add(()=>d.removeEventListener("mousedown",R)),this.subs.add(()=>d.removeEventListener("touchstart",R))}disconnectedCallback(){this.subs.close()}});
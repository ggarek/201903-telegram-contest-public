import e from"./scale.js";import{createCanvas as t}from"./utils/createCanvas.js";import{renderCanvas as o}from"./utils/renderTools.js";import{listenEventSource as s}from"./utils/observable.js";import{asEventSourceProxy as a}from"./utils/eventSourceProxy.js";import{createAnimator as n}from"./utils/ki.js";import{createCursor as r}from"./cursor.js";const l=e=>e.length&&e.length>0?e[e.length-1]:null,i=e=>[e[0],l(e)],c=new Intl.DateTimeFormat(navigator.language||"en",{month:"short",day:"numeric"}),d=e=>{const{weekday:t,month:o,day:s}=c.formatToParts(e).reduce((e,{type:t,value:o})=>(e[t]=o,e),{});return`${o} ${s}`},h=e=>{const[t,o]=e.domain(),s=o-t,a=Math.floor(s/5),n=Math.floor(t/a)*a,r=[];let l=0;for(;;){const e=n+l++*a;if(!(e<t)){if(e>o)break;r.push(e)}}return r};const m=e=>e.map(({colors:e,columns:t,types:o})=>{const s=Object.keys(o).reduce((e,t)=>e||"x"===o[t]?t:null,null),a=t.findIndex(([e])=>e===s);if(a<0)return null;const n=t[a].slice(1);return t.splice(a,1),{x:n,y:t.map(t=>{const s=t[0];return{id:s,name:s,type:o[s],style:{strokeColor:e[s]},values:t.slice(1),shouldRender:!0}})}}).filter(Boolean),u="10px Arial, sans-serif",y={chartXAxis:{labelFontColor:"rgba(14,14,14,0.55)",tickColor:"rgba(14,14,14,0.05)",fontFamily:u},chartYAxis:{labelFontColor:"rgba(14,14,14,0.55)",tickColor:"rgba(14,14,14,0.05)",fontFamily:u,firstTickColor:"rgba(14,14,14,0.1)"},cursor:{strokeColor:"rgba(14,14,14,0.15)",intersectionFillColor:"white"}},g={...y,chartXAxis:{...y.chartXAxis,labelFontColor:"rgba(255, 255, 255, 0.25)",tickColor:"rgba(255, 255, 255, 0.05)"},chartYAxis:{...y.chartYAxis,labelFontColor:"rgba(255, 255, 255, 0.25)",tickColor:"rgba(255, 255, 255, 0.05)",firstTickColor:"rgba(255, 255, 255, 0.10)"},cursor:{...y.cursor,strokeColor:"rgba(255, 255, 255, 0.15)",intersectionFillColor:"#242f3e"}};async function f(){const c=await fetch("data/chart_data.json").then(e=>e.json()).then(m);let u=y;const f=c[0].x[0],x=l(c[0].x),[,b]=i([...c[0].y[0].values].sort((e,t)=>e-t)),w=window.innerWidth,C=window.innerHeight,k=window.devicePixelRatio,v=w,S=C,A=Math.floor(1*w),M=v/A,L=.7*S/M,j={width:v,height:.7*S,dpi:k},D=e(f,f+.25*(x-f),-2,A- -2),E=e(0,b,L-10,10),F=t(j),I=t(j),T=document.getElementById("charts");T.appendChild(F),T.appendChild(I);const P=E.createPaddedScaleView(35),R=D.createPaddedScaleView(10),_=r(I);_.setProps({charts:c[0],xscale:D,yscale:P,scale:M,style:u.cursor});let B=!1;const W=()=>{B=!1,o(F.getContext("2d"),F.width,F.height,{yscale:P,xscale:D,scale:M,axisYScale:E,axisXScale:R,charts:c[0],chartsStyle:{lineWidth:2},lineCharts:[{columns:[c[0].x,c[0].y[0].values],style:{...c[0].y[0].style,lineWidth:1}}],axis:[{mainAxis:"column",steps:6,mainAxisScale:P,crossAxisScale:R,formatLabel:e=>Math.floor(e),drawTickLines:!0,style:u.chartYAxis},{mainAxis:"row",steps:5,ticks:h(D),mainAxisScale:R,crossAxisScale:E,formatLabel:d,drawTickLines:!1,style:u.chartXAxis}]})},X=()=>{B||(B=!0,window.requestAnimationFrame(W))};X();const Y=w,V=Y/.8,$={config:{width:Y,height:80,dpi:k},xscale:e(f,x,-2,V- -2),yscale:e(0,b,90,10),scale:.8,charts:c[0],chartsStyle:{lineWidth:1},frameDomain:D.domain(),canvasWidthScale:e(0,V,0,Y),canvasHeightScale:e(0,100,0,80)},H=a($),q=(e,t,o)=>e+(t-e)*o,N=n({get:()=>E.domain(),set(e){E.setDomain(...e)},duration:1e3,interpolation:(e,t,o)=>[q(e[0],t[0],o),q(e[1],t[1],o)]});s(H,"frameDomain").subscribe({next({value:e}){D.setDomain(e[0],e[1]);const t=function(e,t,o,s){let a=-1;for(let t=0;t<e.length;t+=1)if(e[t]>=o){a=t;break}let n=null,r=null;for(let o=a;o<e.length;o+=1){const a=e[o],l=t[o];if(a>s)break;n=null===n?l:Math.min(n,l),r=null===r?l:Math.max(r,l)}return[n,r]}(c[0].x,c[0].y[0].values,e[0],e[1]);t[0]=0,N.set(t),_.recalculateIntersections()}}),s(E,"domain").subscribe({next(){X()}});_.start();const O=document.createElement("tg-minimap");O.setStore(H);const z=document.getElementById("root");z.appendChild(O),O.scheduleRender();const G=document.createElement("tg-chart-switches");G.setSwitches(c[0].y.reduce((e,{id:t,shouldRender:o,style:s})=>(e[t]={id:t,label:t,shouldRender:o,style:s},e),{})),z.appendChild(G),G.addEventListener("change",e=>{c[0].y.forEach(t=>{const o=e.detail[t.id];Boolean(o)===o&&(t.shouldRender=o)}),X(),O.scheduleRender(),_.recalculateIntersections()});const J=document.createElement("tg-intersections-tooltip");z.appendChild(J),s(_,"position").subscribe({next({value:{x:e}}){J.setVisible(!0),J.setState({left:e,timestamp:D.rtod(e),points:_.getIntersections().map(({y:e,name:t,style:o})=>({value:Math.floor(e),label:t,color:o.strokeColor}))})}});const K=document.getElementById("switch-theme");let Q=null;const U=e=>{if(Q===e.isDayMode)return;Q=e.isDayMode;const{classList:t}=document.body;t.add(Q?"_day":"_night"),t.remove(Q?"_night":"_day");const o=Q?"Night":"Day";K.innerText=`Switch to ${o} Mode`};U({isDayMode:!0}),K.addEventListener("click",()=>{U({isDayMode:!Q}),u=Q?y:g,_.setProps({style:u.cursor}),X()}),setTimeout(()=>p(!1),300)}const{setIsLoading:p}=(()=>{let e=!0;return{setIsLoading:t=>{e!==t&&(e=t,document.body.classList[e?"remove":"add"]("_loaded"))}}})();window.addEventListener("load",()=>{f()});
import e from"./scale.js";import{createCanvas as a,resizeCanvas as t}from"./utils/createCanvas.js";import{renderCanvas as i}from"./utils/renderTools.js";import{listenEventSource as n}from"./utils/observable.js";import{asEventSourceProxy as s}from"./utils/eventSourceProxy.js";import{createAnimator as o}from"./utils/ki.js";import{createCursor as r}from"./cursor.js";const c=e=>e.length&&e.length>0?e[e.length-1]:null,l=e=>[e[0],c(e)],d=new Intl.DateTimeFormat(navigator.language||"en",{month:"short",day:"numeric"}),m=e=>{const{weekday:a,month:t,day:i}=d.formatToParts(e).reduce((e,{type:a,value:t})=>(e[a]=t,e),{});return`${t} ${i}`},h=e=>{const[a,t]=e.domain(),i=t-a,n=Math.floor(i/5),s=Math.floor(a/n)*n,o=[];let r=0;for(;;){const e=s+r++*n;if(!(e<a)){if(e>t)break;o.push(e)}}return o};const p=e=>e.map(({colors:e,columns:a,types:t})=>{const i=Object.keys(t).reduce((e,a)=>e||"x"===t[a]?a:null,null),n=a.findIndex(([e])=>e===i);if(n<0)return null;const s=a[n].slice(1);return a.splice(n,1),{x:s,y:a.map(a=>{const i=a[0];return{id:i,name:i,type:t[i],style:{strokeColor:e[i]},values:a.slice(1),shouldRender:!0}})}}).filter(Boolean),g="10px Arial, sans-serif",u={id:"day",chartXAxis:{labelFontColor:"rgba(14,14,14,0.55)",tickColor:"rgba(14,14,14,0.05)",fontFamily:g},chartYAxis:{labelFontColor:"rgba(14,14,14,0.55)",tickColor:"rgba(14,14,14,0.05)",fontFamily:g,firstTickColor:"rgba(14,14,14,0.1)"},cursor:{strokeColor:"rgba(14,14,14,0.15)",intersectionFillColor:"white"}},v=[u,{...u,id:"night",chartXAxis:{...u.chartXAxis,labelFontColor:"rgba(255, 255, 255, 0.25)",tickColor:"rgba(255, 255, 255, 0.05)"},chartYAxis:{...u.chartYAxis,labelFontColor:"rgba(255, 255, 255, 0.25)",tickColor:"rgba(255, 255, 255, 0.05)",firstTickColor:"rgba(255, 255, 255, 0.10)"},cursor:{...u.cursor,strokeColor:"rgba(255, 255, 255, 0.15)",intersectionFillColor:"#242f3e"}}].reduce((e,a)=>(e[a.id]=a,e),{}),y=({isLandscape:e,viewportWidth:a,viewportHeight:t})=>{const i=(e?.7:1)*a,n=(e?.8:.7)*t,s=Math.floor(1*a),o=i/s;return{canvasWidth:i,canvasHeight:n,areaWidth:s,areaHeight:n/o,canvasScale:o}},x=({minDomain:e,maxDomain:a,padding:t,areaWidth:i})=>[e,e+.25*(a-e),0+t,i-t],w=({minDomain:e,maxDomain:a,areaHeight:t,padding:i})=>[e,a,t-i,0+i],f=({isLandscape:e,viewportWidth:a,viewportHeight:t})=>{const i=(e?.7:1)*a,n=(e?.2:.07)*t,s=n/100;return{minimapCanvasWidth:i,minimapCanvasHeight:n,minimapAreaWidth:i/s,minimapAreaHeight:100,miminmapCanvasScale:s}},b=({minDomain:e,maxDomain:a,padding:t,areaWidth:i})=>[e,a,0+t,i-t],C=({minDomain:e,maxDomain:a,areaHeight:t,padding:i})=>[e,a,t-i,0+i],S=window.devicePixelRatio;async function D(){const d=await fetch("data/chart_data.json").then(e=>e.json()).then(p),g=document.getElementById("root");d.forEach(d=>{const p=document.createElement("div");p.classList.add("chart-panel"),p.innerHTML='\n    <header class="charts-header">Followers</header>\n    <div class="charts-container">\n      <div class="charts canvas-container">\n      </div>\n    </div>\n    <div class="extra-panel">\n      <div class="switch-theme">Switch</div>\n    </div>\n',g.appendChild(p),function({chart:d,root:p,layout:g}){const u={mainCanvas:{canvasScale:1}},v=d.x[0],D=c(d.x),[,L]=l([...d.y[0].values].sort((e,a)=>e-a)),k=window.innerWidth,E=window.innerHeight,R=k>E,{canvasWidth:F,canvasHeight:T,areaWidth:I,areaHeight:j,canvasScale:P}=y({isLandscape:R,viewportWidth:k,viewportHeight:E});u.mainCanvas.canvasScale=P;const M={width:F,height:T,dpi:S},_=e(...x({minDomain:v,maxDomain:D,areaWidth:I,padding:-2})),q=e(...w({minDomain:0,maxDomain:L,areaHeight:j,padding:10})),B=a(M),X=a(M),Y=g.charts;Y.appendChild(B),Y.appendChild(X);const V=q.createPaddedScaleView(35),$=_.createPaddedScaleView(10),O=r(X);O.setProps({charts:d,xscale:_,yscale:V,scale:P,style:W.theme.cursor});let z=!1;const G=()=>{z=!1,i(B.getContext("2d"),B.width,B.height,{yscale:V,xscale:_,scale:u.mainCanvas.canvasScale,axisYScale:q,axisXScale:$,charts:d,chartsStyle:{lineWidth:2},lineCharts:[{columns:[d.x,d.y[0].values],style:{...d.y[0].style,lineWidth:1}}],axis:[{mainAxis:"column",steps:6,mainAxisScale:V,crossAxisScale:$,formatLabel:e=>Math.floor(e),drawTickLines:!0,style:W.theme.chartYAxis},{mainAxis:"row",steps:5,ticks:h(_),mainAxisScale:$,crossAxisScale:q,formatLabel:m,drawTickLines:!1,style:W.theme.chartXAxis}]})},N=()=>{z||(z=!0,window.requestAnimationFrame(G))};N();const{minimapCanvasWidth:U,minimapCanvasHeight:J,minimapAreaWidth:K,minimapAreaHeight:Q,miminmapCanvasScale:Z}=f({isLandscape:R,viewportWidth:k,viewportHeight:E}),ee={width:U,height:J,dpi:S},ae=e(...b({minDomain:v,maxDomain:D,padding:-2,areaWidth:K})),te=e(...C({minDomain:0,maxDomain:L,areaHeight:Q,padding:10})),ie={config:ee,xscale:ae,yscale:te,scale:Z,charts:d,chartsStyle:{lineWidth:1},frameDomain:_.domain(),canvasWidthScale:e(0,K,0,U),canvasHeightScale:e(0,Q,0,J)},ne=s(ie),se=(e,a,t)=>e+(a-e)*t,oe=o({get:()=>q.domain(),set(e){q.setDomain(...e)},duration:1e3,interpolation:(e,a,t)=>[se(e[0],a[0],t),se(e[1],a[1],t)]}),re=([e,a])=>{const t=function(e,a,t,i){let n=-1;for(let a=0;a<e.length;a+=1)if(e[a]>=t){n=a;break}let s=null,o=null;for(let t=n;t<e.length;t+=1){const n=e[t],r=a[t];if(n>i)break;s=null===s?r:Math.min(s,r),o=null===o?r:Math.max(o,r)}return[s,o]}(d.x,d.y[0].values,e,a);t[0]=0,oe.set(t)};n(ne,"frameDomain").subscribe({next({value:e}){_.setDomain(e[0],e[1]),re(e),O.recalculateIntersections()}}),n(q,"domain").subscribe({next(){N()}});O.start();const ce=document.createElement("tg-minimap");ce.setStore(ne),g.chartsContainer.appendChild(ce),ce.scheduleRender();const le=document.createElement("tg-chart-switches");le.setSwitches(d.y.reduce((e,{id:a,shouldRender:t,style:i})=>(e[a]={id:a,label:a,shouldRender:t,style:i},e),{})),g.extraPanel.appendChild(le),le.addEventListener("change",e=>{d.y.forEach(a=>{const t=e.detail[a.id];Boolean(t)===t&&(a.shouldRender=t)}),N(),ce.scheduleRender(),O.recalculateIntersections()});const de=document.createElement("tg-intersections-tooltip");Y.appendChild(de),n(O,"position").subscribe({next({value:{x:e}}){de.setVisible(!0),de.setState({left:e,timestamp:_.rtod(e),points:O.getIntersections().map(({y:e,name:a,style:t})=>({value:Math.floor(e),label:a,color:t.strokeColor}))})}});const me=g.themeSwitch,he=()=>{const e="day"===W.theme.id,a=e?"Night":"Day";me.innerText=`Switch to ${a} Mode`};he(),me.addEventListener("click",H),n(W,"theme").subscribe({next({value:e}){he(),O.setProps({style:e.cursor}),N()}});window.addEventListener("resize",((e,a)=>{let t=null,i=null;return(...n)=>{i=n,t||(t=setTimeout(()=>{try{e(...i)}finally{t=null}},a))}})(()=>{const e=window.innerWidth,a=window.innerHeight,i=e>a,{canvasWidth:n,canvasHeight:s,areaWidth:o,areaHeight:r,canvasScale:c}=y({isLandscape:i,viewportWidth:e,viewportHeight:a}),l={width:n,height:s,dpi:S};t(X,l),O.setProps({scale:c}),t(B,l),u.mainCanvas.canvasScale=c;const[d,m,h,p]=x({minDomain:v,maxDomain:D,areaWidth:o,padding:-2});_.setDomain(d,m),_.setRange(h,p);const[g,W,H,A]=w({minDomain:0,maxDomain:L,areaHeight:r,padding:10});q.setDomain(g,W),q.setRange(H,A),N();const{minimapCanvasWidth:k,minimapCanvasHeight:E,minimapAreaWidth:R,minimapAreaHeight:F,miminmapCanvasScale:T}=f({isLandscape:i,viewportWidth:e,viewportHeight:a});t(ce.canvas,{width:k,height:E,dpi:S}),ie.scale=T,ie.canvasWidthScale.setDomain(0,R),ie.canvasWidthScale.setRange(0,k),ie.canvasHeightScale.setDomain(0,F),ie.canvasHeightScale.setRange(0,E);const I=b({minDomain:v,maxDomain:D,padding:-2,areaWidth:R});ie.xscale.setDomain(I[0],I[1]),ie.xscale.setRange(I[2],I[3]);const j=C({minDomain:0,maxDomain:L,areaHeight:F,padding:10});ie.yscale.setDomain(...j.slice(0,2)),ie.yscale.setRange(...j.slice(2)),ce.forceUpdateFrameDomain(),ce.scheduleRender(),O.recalculateIntersections()},200)),setTimeout(()=>{A(!1)},300)}({chart:d,root:p,layout:{chartsContainer:p.querySelector(".charts-container"),charts:p.querySelector(".charts"),themeSwitch:p.querySelector(".switch-theme"),extraPanel:p.querySelector(".extra-panel")}})})}let W=s({theme:u});document.body.classList.add("_day");const H=()=>{const e="night"===W.theme.id,a=e?"day":"night";W.theme=v[a];const{classList:t}=document.body;t.add(e?"_day":"_night"),t.remove(e?"_night":"_day")};const{setIsLoading:A}=(()=>{let e=!0;return{setIsLoading:a=>{e!==a&&(e=a,document.body.classList[e?"remove":"add"]("_loaded"))}}})();window.addEventListener("load",()=>{D(),setTimeout(()=>{const e=document.createElement("link");e.setAttribute("href","https://fonts.googleapis.com/css?family=Germania+One"),e.setAttribute("rel","stylesheet"),document.body.appendChild(e)},300)});const L=document.getElementById("open-info"),k=document.getElementById("info");L.addEventListener("click",()=>{k.classList.toggle("_open")});
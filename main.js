import e from"./scale.js";import{createCanvas as a,resizeCanvas as t}from"./utils/createCanvas.js";import{renderCanvas as i}from"./utils/renderTools.js";import{listenEventSource as n}from"./utils/observable.js";import{asEventSourceProxy as s}from"./utils/eventSourceProxy.js";import{createAnimator as o}from"./utils/ki.js";import{createCursor as r}from"./cursor.js";const l=e=>e.length&&e.length>0?e[e.length-1]:null,c=e=>[e[0],l(e)],d=new Intl.DateTimeFormat(navigator.language||"en",{month:"short",day:"numeric"}),m=e=>{const{weekday:a,month:t,day:i}=d.formatToParts(e).reduce((e,{type:a,value:t})=>(e[a]=t,e),{});return`${t} ${i}`},h=e=>{const[a,t]=e.domain(),i=t-a,n=Math.floor(i/5),s=Math.floor(a/n)*n,o=[];let r=0;for(;;){const e=s+r++*n;if(!(e<a)){if(e>t)break;o.push(e)}}return o};const g=e=>e.map(({colors:e,columns:a,types:t})=>{const i=Object.keys(t).reduce((e,a)=>e||"x"===t[a]?a:null,null),n=a.findIndex(([e])=>e===i);if(n<0)return null;const s=a[n].slice(1);return a.splice(n,1),{x:s,y:a.map(a=>{const i=a[0];return{id:i,name:i,type:t[i],style:{strokeColor:e[i]},values:a.slice(1),shouldRender:!0}})}}).filter(Boolean),p="10px Arial, sans-serif",u={chartXAxis:{labelFontColor:"rgba(14,14,14,0.55)",tickColor:"rgba(14,14,14,0.05)",fontFamily:p},chartYAxis:{labelFontColor:"rgba(14,14,14,0.55)",tickColor:"rgba(14,14,14,0.05)",fontFamily:p,firstTickColor:"rgba(14,14,14,0.1)"},cursor:{strokeColor:"rgba(14,14,14,0.15)",intersectionFillColor:"white"}},v={...u,chartXAxis:{...u.chartXAxis,labelFontColor:"rgba(255, 255, 255, 0.25)",tickColor:"rgba(255, 255, 255, 0.05)"},chartYAxis:{...u.chartYAxis,labelFontColor:"rgba(255, 255, 255, 0.25)",tickColor:"rgba(255, 255, 255, 0.05)",firstTickColor:"rgba(255, 255, 255, 0.10)"},cursor:{...u.cursor,strokeColor:"rgba(255, 255, 255, 0.15)",intersectionFillColor:"#242f3e"}},y=({isLandscape:e,viewportWidth:a,viewportHeight:t})=>{const i=(e?.7:1)*a,n=(e?.8:.7)*t,s=Math.floor(1*a),o=i/s;return{canvasWidth:i,canvasHeight:n,areaWidth:s,areaHeight:n/o,canvasScale:o}},x=({minDomain:e,maxDomain:a,padding:t,areaWidth:i})=>[e,e+.25*(a-e),0+t,i-t],f=({minDomain:e,maxDomain:a,areaHeight:t,padding:i})=>[e,a,t-i,0+i],w=({isLandscape:e,viewportWidth:a,viewportHeight:t})=>{const i=(e?.7:1)*a,n=(e?.2:.07)*t,s=n/100;return{minimapCanvasWidth:i,minimapCanvasHeight:n,minimapAreaWidth:i/s,minimapAreaHeight:100,miminmapCanvasScale:s}},D=({minDomain:e,maxDomain:a,padding:t,areaWidth:i})=>[e,a,0+t,i-t],b=({minDomain:e,maxDomain:a,areaHeight:t,padding:i})=>[e,a,t-i,0+i],C=window.devicePixelRatio;async function W(){const d=await fetch("data/chart_data.json").then(e=>e.json()).then(g),p={mainCanvas:{canvasScale:1}};let W=u;const H=d[0].x[0],A=l(d[0].x),[,k]=c([...d[0].y[0].values].sort((e,a)=>e-a)),L=window.innerWidth,E=window.innerHeight,I=L>E,{canvasWidth:R,canvasHeight:M,areaWidth:F,areaHeight:j,canvasScale:T}=y({isLandscape:I,viewportWidth:L,viewportHeight:E});p.mainCanvas.canvasScale=T;const B={width:R,height:M,dpi:C},P=e(...x({minDomain:H,maxDomain:A,areaWidth:F,padding:-2})),_=e(...f({minDomain:0,maxDomain:k,areaHeight:j,padding:10})),X=a(B),Y=a(B),V=document.getElementById("charts");V.appendChild(X),V.appendChild(Y);const $=_.createPaddedScaleView(35),O=P.createPaddedScaleView(10),q=r(Y);q.setProps({charts:d[0],xscale:P,yscale:$,scale:T,style:W.cursor});let z=!1;const G=()=>{z=!1,i(X.getContext("2d"),X.width,X.height,{yscale:$,xscale:P,scale:p.mainCanvas.canvasScale,axisYScale:_,axisXScale:O,charts:d[0],chartsStyle:{lineWidth:2},lineCharts:[{columns:[d[0].x,d[0].y[0].values],style:{...d[0].y[0].style,lineWidth:1}}],axis:[{mainAxis:"column",steps:6,mainAxisScale:$,crossAxisScale:O,formatLabel:e=>Math.floor(e),drawTickLines:!0,style:W.chartYAxis},{mainAxis:"row",steps:5,ticks:h(P),mainAxisScale:O,crossAxisScale:_,formatLabel:m,drawTickLines:!1,style:W.chartXAxis}]})},N=()=>{z||(z=!0,window.requestAnimationFrame(G))};N();const{minimapCanvasWidth:U,minimapCanvasHeight:J,minimapAreaWidth:K,minimapAreaHeight:Q,miminmapCanvasScale:Z}=w({isLandscape:I,viewportWidth:L,viewportHeight:E}),ee={config:{width:U,height:J,dpi:C},xscale:e(...D({minDomain:H,maxDomain:A,padding:-2,areaWidth:K})),yscale:e(...b({minDomain:0,maxDomain:k,areaHeight:Q,padding:10})),scale:Z,charts:d[0],chartsStyle:{lineWidth:1},frameDomain:P.domain(),canvasWidthScale:e(0,K,0,U),canvasHeightScale:e(0,Q,0,J)},ae=s(ee),te=(e,a,t)=>e+(a-e)*t,ie=o({get:()=>_.domain(),set(e){_.setDomain(...e)},duration:1e3,interpolation:(e,a,t)=>[te(e[0],a[0],t),te(e[1],a[1],t)]}),ne=([e,a])=>{const t=function(e,a,t,i){let n=-1;for(let a=0;a<e.length;a+=1)if(e[a]>=t){n=a;break}let s=null,o=null;for(let t=n;t<e.length;t+=1){const n=e[t],r=a[t];if(n>i)break;s=null===s?r:Math.min(s,r),o=null===o?r:Math.max(o,r)}return[s,o]}(d[0].x,d[0].y[0].values,e,a);t[0]=0,ie.set(t)};n(ae,"frameDomain").subscribe({next({value:e}){P.setDomain(e[0],e[1]),ne(e),q.recalculateIntersections()}}),n(_,"domain").subscribe({next(){N()}});q.start();const se=document.createElement("tg-minimap");se.setStore(ae);const oe=document.getElementById("root");document.getElementById("charts-container").appendChild(se),se.scheduleRender();const re=document.createElement("tg-chart-switches");re.setSwitches(d[0].y.reduce((e,{id:a,shouldRender:t,style:i})=>(e[a]={id:a,label:a,shouldRender:t,style:i},e),{})),oe.appendChild(re),re.addEventListener("change",e=>{d[0].y.forEach(a=>{const t=e.detail[a.id];Boolean(t)===t&&(a.shouldRender=t)}),N(),se.scheduleRender(),q.recalculateIntersections()});const le=document.createElement("tg-intersections-tooltip");oe.appendChild(le),n(q,"position").subscribe({next({value:{x:e}}){le.setVisible(!0),le.setState({left:e,timestamp:P.rtod(e),points:q.getIntersections().map(({y:e,name:a,style:t})=>({value:Math.floor(e),label:a,color:t.strokeColor}))})}});const ce=document.getElementById("switch-theme");let de=null;const me=e=>{if(de===e.isDayMode)return;de=e.isDayMode;const{classList:a}=document.body;a.add(de?"_day":"_night"),a.remove(de?"_night":"_day");const t=de?"Night":"Day";ce.innerText=`Switch to ${t} Mode`};me({isDayMode:!0}),ce.addEventListener("click",()=>{me({isDayMode:!de}),W=de?u:v,q.setProps({style:W.cursor}),N()});window.addEventListener("resize",((e,a)=>{let t=null,i=null;return(...n)=>{i=n,t||(t=setTimeout(()=>{try{e(...i)}finally{t=null}},a))}})(()=>{const e=window.innerWidth,a=window.innerHeight,i=e>a,{canvasWidth:n,canvasHeight:s,areaWidth:o,areaHeight:r,canvasScale:l}=y({isLandscape:i,viewportWidth:e,viewportHeight:a}),c={width:n,height:s,dpi:C};t(Y,c),q.setProps({scale:l}),t(X,c),p.mainCanvas.canvasScale=l;const[d,m,h,g]=x({minDomain:H,maxDomain:A,areaWidth:o,padding:-2});P.setDomain(d,m),P.setRange(h,g);const[u,v,W,S]=f({minDomain:0,maxDomain:k,areaHeight:r,padding:10});_.setDomain(u,v),_.setRange(W,S),N();const{minimapCanvasWidth:L,minimapCanvasHeight:E,minimapAreaWidth:I,minimapAreaHeight:R,miminmapCanvasScale:M}=w({isLandscape:i,viewportWidth:e,viewportHeight:a});t(se.canvas,{width:L,height:E,dpi:C}),ee.scale=M,ee.canvasWidthScale.setDomain(0,I),ee.canvasWidthScale.setRange(0,L),ee.canvasHeightScale.setDomain(0,R),ee.canvasHeightScale.setRange(0,E);const F=D({minDomain:H,maxDomain:A,padding:-2,areaWidth:I});ee.xscale.setDomain(F[0],F[1]),ee.xscale.setRange(F[2],F[3]);const j=b({minDomain:0,maxDomain:k,areaHeight:R,padding:10});ee.yscale.setDomain(...j.slice(0,2)),ee.yscale.setRange(...j.slice(2)),se.forceUpdateFrameDomain(),se.scheduleRender(),q.recalculateIntersections()},200)),setTimeout(()=>{S(!1);const e=document.createElement("link");e.setAttribute("href","https://fonts.googleapis.com/css?family=Germania+One"),e.setAttribute("rel","stylesheet"),document.body.appendChild(e)},300)}const{setIsLoading:S}=(()=>{let e=!0;return{setIsLoading:a=>{e!==a&&(e=a,document.body.classList[e?"remove":"add"]("_loaded"))}}})();window.addEventListener("load",()=>{W()});const H=document.getElementById("open-info"),A=document.getElementById("info");H.addEventListener("click",()=>{A.classList.toggle("_open")});